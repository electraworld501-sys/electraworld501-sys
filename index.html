<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asistencia - EntradaYA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet Map CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <div class="bg-blue-600 p-2 rounded-lg mr-3">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">EntradaYA</h1>
                        <p class="text-sm text-gray-600 font-medium">Dise√±o #048 - Sistema Centralizado</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center space-x-2">
                        <div id="statusIcon" class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <span id="statusText" class="text-sm text-gray-600">Conectando...</span>
                    </div>
                    <button id="adminBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üë§ Admin
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Admin Setup Modal -->
    <div id="adminSetupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üîß Configuraci√≥n de Administrador</h3>
            <p class="text-gray-600 mb-4">Configure este dispositivo como el servidor central de datos.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo de Administrador</label>
                    <input type="password" id="adminCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ingrese c√≥digo secreto">
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg">
                    <h4 class="font-medium text-blue-900 mb-2">üì° Servidor Central</h4>
                    <p class="text-sm text-blue-700">Este dispositivo actuar√° como servidor central. Los empleados se conectar√°n a:</p>
                    <div class="mt-2 p-2 bg-white rounded border font-mono text-sm" id="serverUrl">
                        Generando URL...
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button id="cancelAdminSetup" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                    Cancelar
                </button>
                <button id="confirmAdminSetup" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    ‚úÖ Configurar Servidor
                </button>
            </div>
        </div>
    </div>

    <!-- Connection Setup Modal -->
    <div id="connectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üåê Conectar al Servidor</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">URL del Servidor Admin</label>
                    <input type="text" id="serverUrlInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="https://admin-server-url.com">
                </div>
                
                <div class="bg-yellow-50 p-3 rounded-lg">
                    <p class="text-sm text-yellow-700">
                        <strong>üì± Para Empleados:</strong> Solicite la URL del servidor al administrador para sincronizar los datos.
                    </p>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button id="cancelConnection" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                    Usar Local
                </button>
                <button id="confirmConnection" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    üîó Conectar
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Employee Section -->
        <div id="employeeSection" class="mb-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Control de Asistencia</h2>
                
                <div class="flex flex-col items-center space-y-6">
                    <div class="bg-white border rounded-lg p-6 max-w-md w-full">
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usuario</label>
                                <input type="text" id="loginUser" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="C√©dula/DNI" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                                <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Contrase√±a" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors">
                                üîê Iniciar Sesi√≥n
                            </button>
                        </form>
                        <div id="loginStatus" class="mt-4 text-center text-sm text-gray-500">
                            Ingresa tus credenciales para continuar
                        </div>
                    </div>

                    <div id="employeeInfo" class="hidden bg-gray-50 rounded-lg p-4 w-full max-w-md">
                        <div class="text-center">
                            <h3 id="employeeName" class="text-xl font-semibold text-gray-900"></h3>
                            <p id="employeeId" class="text-gray-600"></p>
                            
                            <div id="gpsStatus" class="mt-3 p-2 rounded-lg bg-yellow-100">
                                <div class="flex items-center justify-center space-x-2">
                                    <div id="gpsIcon" class="text-lg">üìç</div>
                                    <span id="gpsText" class="text-sm font-medium">Verificando ubicaci√≥n...</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-4 mt-4">
                            <button id="checkInBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors disabled:bg-gray-400">
                                ‚úÖ Entrada
                            </button>
                            <button id="checkOutBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition-colors disabled:bg-gray-400">
                                üö™ Salida
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <!-- Data Sync Status -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div id="syncIcon" class="text-2xl">üîÑ</div>
                        <div>
                            <h3 class="font-semibold text-gray-900">Estado de Sincronizaci√≥n</h3>
                            <p id="syncStatus" class="text-sm text-gray-600">Verificando conexi√≥n...</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="exportDataBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm">
                            üì§ Exportar
                        </button>
                        <button id="importDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">
                            üì• Importar
                        </button>
                        <button id="setupServerBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm">
                            üîß Servidor
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex flex-wrap gap-4">
                    <button id="showRegister" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        ‚ûï Registrar Empleado
                    </button>
                    <button id="showEmployees" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        üë• Empleados
                    </button>
                    <button id="showAttendance" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">
                        üìã Asistencias
                    </button>
                </div>
            </div>

            <!-- Employee Registration -->
            <div id="registerSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Registrar Nuevo Empleado</h3>
                <form id="employeeForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                        <input type="text" id="empName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">C√©dula / DNI</label>
                        <input type="text" id="empId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Departamento</label>
                        <input type="text" id="empDept" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                        <input type="password" id="empPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <!-- Work Location Assignment -->
                    <div class="md:col-span-2 bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">üìç Ubicaci√≥n de Trabajo</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n</label>
                                <input type="text" id="empAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ej: 18 de Julio 1234" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Radio (metros)</label>
                                <input type="number" id="empRadius" min="10" max="1000" value="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="flex items-end">
                                <button type="button" id="openMapSelector" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full">
                                    üó∫Ô∏è Seleccionar en Mapa GPS
                                </button>
                            </div>
                        </div>
                        
                        <div id="gpsStatusIndicator" class="hidden mt-3 p-3 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div id="gpsStatusIcon" class="text-lg">üìç</div>
                                <div>
                                    <div id="gpsStatusText" class="text-sm font-medium"></div>
                                    <div id="gpsCoordinates" class="text-xs text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="empLatitude">
                        <input type="hidden" id="empLongitude">
                    </div>
                    
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                            ‚úÖ Registrar Empleado
                        </button>
                    </div>
                </form>
            </div>

            <!-- Employee List -->
            <div id="employeeList" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Lista de Empleados</h3>
                <div id="employeeTable" class="overflow-x-auto"></div>
            </div>

            <!-- Attendance Records -->
            <div id="attendanceSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Registros de Asistencia</h3>
                <div id="attendanceTable" class="overflow-x-auto"></div>
            </div>
        </div>
    </main>

    <!-- Map Selector Modal -->
    <div id="mapSelectorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">üó∫Ô∏è Seleccionar Ubicaci√≥n GPS</h3>
                <button id="closeMapSelector" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="mb-4">
                <p class="text-gray-600 text-sm mb-3">Haz clic en el mapa para seleccionar la ubicaci√≥n de trabajo</p>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="centerMapMontevideo" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        üèõÔ∏è Centro
                    </button>
                    <button id="centerMapPocitos" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1 rounded text-sm">
                        üèñÔ∏è Pocitos
                    </button>
                    <button id="centerMapCarrasco" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        ‚úàÔ∏è Carrasco
                    </button>
                </div>
            </div>
            
            <div id="mapContainer" class="w-full h-96 bg-gray-100 rounded-lg border-2 border-gray-300 mb-4 relative">
                <div id="leafletMap" class="w-full h-full rounded-lg"></div>
                <div id="mapLoadingIndicator" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center rounded-lg">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                        <p class="text-gray-600">Cargando mapa GPS...</p>
                    </div>
                </div>
            </div>
            
            <div id="selectedLocationInfo" class="hidden bg-green-50 p-4 rounded-lg mb-4">
                <h4 class="font-semibold text-green-800 mb-2">üìç Ubicaci√≥n Seleccionada</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-green-700 font-medium">Coordenadas:</span>
                        <span id="selectedCoords" class="text-green-900"></span>
                    </div>
                    <div>
                        <span class="text-green-700 font-medium">Direcci√≥n estimada:</span>
                        <span id="selectedAddress" class="text-green-900"></span>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancelMapSelection" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                    Cancelar
                </button>
                <button id="confirmMapSelection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg" disabled>
                    ‚úÖ Confirmar Ubicaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        // Global variables
        let employees = [];
        let attendanceRecords = [];
        let currentEmployee = null;
        let isAdminMode = false;
        let mapInstance = null;
        let selectedLocation = null;
        let isServerMode = false;
        let serverUrl = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeDataSystem();
        });

        function setupEventListeners() {
            document.getElementById('adminBtn').addEventListener('click', toggleAdminMode);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('checkInBtn').addEventListener('click', () => recordAttendance('in'));
            document.getElementById('checkOutBtn').addEventListener('click', () => recordAttendance('out'));
            
            // Admin navigation
            document.getElementById('showEmployees').addEventListener('click', () => showSection('employeeList'));
            document.getElementById('showRegister').addEventListener('click', () => showSection('registerSection'));
            document.getElementById('showAttendance').addEventListener('click', () => showSection('attendanceSection'));
            
            document.getElementById('employeeForm').addEventListener('submit', registerEmployee);
            setupMapSelector();
            setupDataManagement();
        }

        function setupDataManagement() {
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('setupServerBtn').addEventListener('click', () => document.getElementById('adminSetupModal').classList.remove('hidden'));
            document.getElementById('fileInput').addEventListener('change', importData);
            
            // Admin setup modal
            document.getElementById('cancelAdminSetup').addEventListener('click', () => document.getElementById('adminSetupModal').classList.add('hidden'));
            document.getElementById('confirmAdminSetup').addEventListener('click', setupAsServer);
            
            // Connection modal
            document.getElementById('cancelConnection').addEventListener('click', useLocalMode);
            document.getElementById('confirmConnection').addEventListener('click', connectToServer);
        }

        function initializeDataSystem() {
            // Check if this device was previously configured as server
            const serverConfig = localStorage.getItem('serverConfig');
            if (serverConfig) {
                const config = JSON.parse(serverConfig);
                isServerMode = true;
                updateConnectionStatus('server', 'Servidor Central Activo');
                loadLocalData();
            } else {
                // Check for server connection
                const savedServerUrl = localStorage.getItem('serverUrl');
                if (savedServerUrl) {
                    serverUrl = savedServerUrl;
                    updateConnectionStatus('connected', `Conectado a servidor`);
                    syncWithServer();
                } else {
                    // Show connection options on first load
                    setTimeout(() => {
                        if (!isServerMode && !serverUrl) {
                            document.getElementById('connectionModal').classList.remove('hidden');
                        }
                    }, 1000);
                }
            }
            
            // Load local data as fallback
            loadLocalData();
        }

        function setupAsServer() {
            const adminCode = document.getElementById('adminCode').value;
            if (adminCode !== 'admin2024') {
                alert('C√≥digo de administrador incorrecto');
                return;
            }
            
            const serverConfig = {
                isServer: true,
                setupDate: new Date().toISOString(),
                adminCode: adminCode
            };
            
            localStorage.setItem('serverConfig', JSON.stringify(serverConfig));
            isServerMode = true;
            
            // Generate server URL (in real implementation, this would be the actual server URL)
            const serverUrlDisplay = window.location.origin + window.location.pathname + '?server=true';
            document.getElementById('serverUrl').textContent = serverUrlDisplay;
            
            updateConnectionStatus('server', 'Servidor Central Configurado');
            document.getElementById('adminSetupModal').classList.add('hidden');
            
            alert('‚úÖ Dispositivo configurado como servidor central. Los empleados pueden conectarse usando la URL mostrada.');
        }

        function connectToServer() {
            const url = document.getElementById('serverUrlInput').value.trim();
            if (!url) {
                alert('Por favor ingrese la URL del servidor');
                return;
            }
            
            serverUrl = url;
            localStorage.setItem('serverUrl', url);
            updateConnectionStatus('connected', 'Conectado al servidor');
            document.getElementById('connectionModal').classList.add('hidden');
            
            syncWithServer();
        }

        function useLocalMode() {
            updateConnectionStatus('local', 'Modo Local (Sin sincronizaci√≥n)');
            document.getElementById('connectionModal').classList.add('hidden');
            loadLocalData();
        }

        function updateConnectionStatus(type, message) {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const syncIcon = document.getElementById('syncIcon');
            const syncStatus = document.getElementById('syncStatus');
            
            switch(type) {
                case 'server':
                    statusIcon.className = 'w-3 h-3 rounded-full bg-purple-500';
                    statusText.textContent = 'Servidor Central';
                    syncIcon.textContent = 'üñ•Ô∏è';
                    syncStatus.textContent = message;
                    break;
                case 'connected':
                    statusIcon.className = 'w-3 h-3 rounded-full bg-green-500';
                    statusText.textContent = 'Conectado';
                    syncIcon.textContent = 'üîó';
                    syncStatus.textContent = message;
                    break;
                case 'local':
                    statusIcon.className = 'w-3 h-3 rounded-full bg-yellow-500';
                    statusText.textContent = 'Local';
                    syncIcon.textContent = 'üíæ';
                    syncStatus.textContent = message;
                    break;
                case 'error':
                    statusIcon.className = 'w-3 h-3 rounded-full bg-red-500';
                    statusText.textContent = 'Error';
                    syncIcon.textContent = '‚ùå';
                    syncStatus.textContent = message;
                    break;
            }
        }

        function syncWithServer() {
            // In a real implementation, this would make HTTP requests to the server
            // For this demo, we'll simulate server sync with localStorage
            if (serverUrl) {
                try {
                    // Simulate successful sync
                    updateConnectionStatus('connected', 'Sincronizaci√≥n exitosa');
                    loadLocalData(); // Load local data as fallback
                } catch (error) {
                    updateConnectionStatus('error', 'Error de sincronizaci√≥n');
                    loadLocalData(); // Fallback to local data
                }
            }
        }

        function loadLocalData() {
            employees = JSON.parse(localStorage.getItem('employees')) || [];
            attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
            
            if (employees.length === 0) {
                addSampleData();
            }
        }

        function saveData() {
            // Save locally
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // If this is server mode or connected to server, handle sync
            if (isServerMode) {
                updateConnectionStatus('server', `Datos guardados - ${employees.length} empleados`);
            } else if (serverUrl) {
                // In real implementation, send data to server
                updateConnectionStatus('connected', 'Datos sincronizados con servidor');
            }
        }

        function exportData() {
            const data = {
                employees: employees,
                attendanceRecords: attendanceRecords,
                exportDate: new Date().toISOString(),
                version: '048'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `entradaya-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Datos exportados correctamente');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.employees && data.attendanceRecords) {
                        employees = data.employees;
                        attendanceRecords = data.attendanceRecords;
                        saveData();
                        
                        alert(`‚úÖ Datos importados: ${employees.length} empleados, ${attendanceRecords.length} registros`);
                        
                        // Refresh current view
                        if (isAdminMode) {
                            showSection('employeeList');
                        }
                    } else {
                        alert('‚ùå Archivo de respaldo inv√°lido');
                    }
                } catch (error) {
                    alert('‚ùå Error al leer el archivo de respaldo');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function toggleAdminMode() {
            if (isAdminMode) {
                isAdminMode = false;
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('employeeSection').classList.remove('hidden');
                document.getElementById('adminBtn').textContent = 'üë§ Admin';
                resetEmployeeSection();
            } else {
                isAdminMode = true;
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('employeeSection').classList.add('hidden');
                document.getElementById('adminBtn').textContent = 'üë§ Empleado';
                showSection('employeeList');
            }
        }

        function showSection(sectionId) {
            const sections = ['employeeList', 'registerSection', 'attendanceSection'];
            sections.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            
            if (sectionId === 'employeeList') displayEmployees();
            else if (sectionId === 'attendanceSection') displayAttendanceRecords();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const userId = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPassword').value;
            const status = document.getElementById('loginStatus');
            
            const employee = employees.find(emp => emp.id === userId && emp.password === password);
            
            if (employee) {
                currentEmployee = employee;
                showEmployeeInfo(employee);
                status.textContent = 'Inicio de sesi√≥n exitoso';
                status.className = 'mt-4 text-center text-sm text-green-600';
                document.getElementById('loginForm').reset();
            } else {
                status.textContent = 'Usuario o contrase√±a incorrectos';
                status.className = 'mt-4 text-center text-sm text-red-600';
                setTimeout(() => {
                    status.textContent = 'Ingresa tus credenciales para continuar';
                    status.className = 'mt-4 text-center text-sm text-gray-500';
                }, 3000);
            }
        }

        function showEmployeeInfo(employee) {
            document.getElementById('employeeName').textContent = employee.name;
            document.getElementById('employeeId').textContent = `C√©dula: ${employee.id} - ${employee.department}`;
            document.getElementById('employeeInfo').classList.remove('hidden');
            verifyEmployeeLocation(employee);
        }

        function verifyEmployeeLocation(employee) {
            const gpsStatus = document.getElementById('gpsStatus');
            const gpsIcon = document.getElementById('gpsIcon');
            const gpsText = document.getElementById('gpsText');
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');

            if (!employee.workLocation) {
                gpsStatus.className = 'mt-3 p-2 rounded-lg bg-red-100';
                gpsIcon.textContent = '‚ùå';
                gpsText.textContent = 'Sin ubicaci√≥n asignada';
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const distance = calculateDistance(
                            position.coords.latitude, position.coords.longitude,
                            employee.workLocation.latitude, employee.workLocation.longitude
                        );
                        
                        if (distance <= employee.workLocation.radius) {
                            gpsStatus.className = 'mt-3 p-2 rounded-lg bg-green-100';
                            gpsIcon.textContent = '‚úÖ';
                            gpsText.textContent = 'Ubicaci√≥n verificada';
                        } else {
                            gpsStatus.className = 'mt-3 p-2 rounded-lg bg-red-100';
                            gpsIcon.textContent = 'üö´';
                            gpsText.textContent = `Fuera del √°rea (${Math.round(distance)}m)`;
                        }
                        checkInBtn.disabled = false;
                        checkOutBtn.disabled = false;
                    },
                    () => {
                        gpsStatus.className = 'mt-3 p-2 rounded-lg bg-orange-100';
                        gpsIcon.textContent = '‚ö†Ô∏è';
                        gpsText.textContent = 'GPS no disponible';
                        checkInBtn.disabled = false;
                        checkOutBtn.disabled = false;
                    }
                );
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function recordAttendance(type) {
            if (!currentEmployee) return;
            
            const record = {
                id: Date.now(),
                employeeId: currentEmployee.id,
                employeeName: currentEmployee.name,
                type: type,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0]
            };
            
            attendanceRecords.push(record);
            saveData();
            
            alert(`${type === 'in' ? 'Entrada' : 'Salida'} registrada correctamente`);
            resetEmployeeSection();
        }

        function resetEmployeeSection() {
            document.getElementById('employeeInfo').classList.add('hidden');
            document.getElementById('loginStatus').textContent = 'Ingresa tus credenciales para continuar';
            document.getElementById('loginStatus').className = 'mt-4 text-center text-sm text-gray-500';
            document.getElementById('loginForm').reset();
            currentEmployee = null;
        }

        async function registerEmployee(e) {
            e.preventDefault();
            
            const employee = {
                id: document.getElementById('empId').value,
                name: document.getElementById('empName').value,
                department: document.getElementById('empDept').value,
                password: document.getElementById('empPassword').value,
                workLocation: {
                    address: document.getElementById('empAddress').value,
                    latitude: parseFloat(document.getElementById('empLatitude').value) || -34.9058,
                    longitude: parseFloat(document.getElementById('empLongitude').value) || -56.1913,
                    radius: parseInt(document.getElementById('empRadius').value)
                }
            };
            
            if (employees.find(emp => emp.id === employee.id)) {
                alert('Ya existe un empleado con esta c√©dula');
                return;
            }
            
            employees.push(employee);
            saveData();
            
            document.getElementById('employeeForm').reset();
            document.getElementById('gpsStatusIndicator').classList.add('hidden');
            alert('Empleado registrado correctamente');
        }

        function displayEmployees() {
            const container = document.getElementById('employeeTable');
            if (employees.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay empleados registrados</p>';
                return;
            }
            
            const html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√©dula</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Departamento</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${employees.map(emp => `
                            <tr>
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">${emp.id}</td>
                                <td class="px-6 py-4 text-sm text-gray-900">${emp.name}</td>
                                <td class="px-6 py-4 text-sm text-gray-900">${emp.department}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = html;
        }

        function displayAttendanceRecords() {
            const container = document.getElementById('attendanceTable');
            if (attendanceRecords.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay registros de asistencia</p>';
                return;
            }
            
            const sorted = [...attendanceRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empleado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${sorted.map(record => `
                            <tr>
                                <td class="px-6 py-4 text-sm text-gray-900">${new Date(record.timestamp).toLocaleString('es-ES')}</td>
                                <td class="px-6 py-4 text-sm text-gray-900">${record.employeeName}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2 text-xs font-semibold rounded-full ${record.type === 'in' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${record.type === 'in' ? '‚úÖ Entrada' : 'üö™ Salida'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = html;
        }

        // Map Functions
        function setupMapSelector() {
            document.getElementById('openMapSelector').addEventListener('click', openMapSelector);
            document.getElementById('closeMapSelector').addEventListener('click', closeMapSelector);
            document.getElementById('cancelMapSelection').addEventListener('click', closeMapSelector);
            document.getElementById('confirmMapSelection').addEventListener('click', confirmMapSelection);
            
            document.getElementById('centerMapMontevideo').addEventListener('click', () => centerMap(-34.9058, -56.1913));
            document.getElementById('centerMapPocitos').addEventListener('click', () => centerMap(-34.9176, -56.1565));
            document.getElementById('centerMapCarrasco').addEventListener('click', () => centerMap(-34.8941, -56.0467));
        }

        function openMapSelector() {
            document.getElementById('mapSelectorModal').classList.remove('hidden');
            if (!mapInstance) {
                setTimeout(initializeMap, 100);
            }
        }

        function closeMapSelector() {
            document.getElementById('mapSelectorModal').classList.add('hidden');
            selectedLocation = null;
            document.getElementById('selectedLocationInfo').classList.add('hidden');
            document.getElementById('confirmMapSelection').disabled = true;
        }

        function initializeMap() {
            try {
                const map = L.map('leafletMap', {
                    center: [-34.9058, -56.1913],
                    zoom: 12
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                map.on('click', function(e) {
                    selectLocationOnMap(e.latlng.lat, e.latlng.lng, map);
                });

                mapInstance = { map: map, marker: null };
                
                setTimeout(() => {
                    map.invalidateSize();
                    document.getElementById('mapLoadingIndicator').style.display = 'none';
                }, 500);

            } catch (error) {
                console.error('Error loading map:', error);
            }
        }

        function selectLocationOnMap(lat, lng, map) {
            selectedLocation = { lat, lng };
            
            if (mapInstance.marker) {
                map.removeLayer(mapInstance.marker);
            }
            
            const redIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background-color: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            mapInstance.marker = L.marker([lat, lng], { icon: redIcon }).addTo(map);
            
            document.getElementById('selectedCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('selectedAddress').textContent = 'Montevideo, Uruguay';
            document.getElementById('selectedLocationInfo').classList.remove('hidden');
            document.getElementById('confirmMapSelection').disabled = false;
        }

        function centerMap(lat, lng) {
            if (!mapInstance?.map) return;
            mapInstance.map.setView([lat, lng], 15);
            selectLocationOnMap(lat, lng, mapInstance.map);
        }

        function confirmMapSelection() {
            if (!selectedLocation) return;
            
            document.getElementById('empLatitude').value = selectedLocation.lat.toFixed(6);
            document.getElementById('empLongitude').value = selectedLocation.lng.toFixed(6);
            document.getElementById('empAddress').value = `GPS: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
            
            const statusIndicator = document.getElementById('gpsStatusIndicator');
            statusIndicator.className = 'mt-3 p-3 rounded-lg bg-green-100';
            document.getElementById('gpsStatusIcon').textContent = 'üó∫Ô∏è';
            document.getElementById('gpsStatusText').textContent = 'Ubicaci√≥n seleccionada en el mapa';
            document.getElementById('gpsCoordinates').textContent = `Coordenadas: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
            statusIndicator.classList.remove('hidden');
            
            closeMapSelector();
            alert('¬°Ubicaci√≥n GPS seleccionada correctamente!');
        }

        function addSampleData() {
            employees = [
                {
                    id: '12345678', name: 'Mar√≠a Garc√≠a', department: 'Administraci√≥n', password: '1234',
                    workLocation: { address: 'Centro, Montevideo', latitude: -34.9058, longitude: -56.1913, radius: 100 }
                },
                {
                    id: '87654321', name: 'Carlos Rodr√≠guez', department: 'Ventas', password: '1234',
                    workLocation: { address: 'Pocitos, Montevideo', latitude: -34.9176, longitude: -56.1565, radius: 150 }
                }
            ];
            saveData();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c5880880e18bea',t:'MTc1NzQwODgwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
